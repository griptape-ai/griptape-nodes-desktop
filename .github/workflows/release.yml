name: Release

on:
  workflow_dispatch:
    inputs:
      channel:
        description: 'Release channel (stable, beta, dev, etc.) - defaults to stable for main and branch name otherwise'
        required: false
        type: string
      skip_s3_upload:
        description: 'Skip S3 upload (for test builds without auto-updates). Defaults to true for non-main branches.'
        required: false
        type: boolean
        default: false

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      should_proceed: ${{ steps.check.outputs.should_proceed }}
      channel: ${{ steps.check.outputs.channel }}
      skip_s3_upload: ${{ steps.check.outputs.skip_s3_upload }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          lfs: true

      - name: Check for existing release
        id: check
        shell: bash
        run: ./scripts/ci/validate-channel.sh "${{ github.ref_name }}" "${{ inputs.channel }}" "${{ inputs.skip_s3_upload }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    needs: validate
    runs-on: ${{ matrix.os }}

    permissions:
      id-token: write # required for OIDC
      contents: write # Required to create new releases with GITHUB_TOKEN

    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest, ubuntu-24.04-arm, windows-latest]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          lfs: true

      - name: Setup platform variables and check for existing release
        id: platform
        run: ./scripts/ci/setup-platform.sh "${{ needs.validate.outputs.channel }}"
        shell: bash

      - name: Configure AWS creds via OIDC
        if: env.DONE != 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::246367841364:role/GriptapeNodesDesktopGithubActions
          aws-region: us-west-2
          role-session-name: gha-${{ github.run_id }}

      - name: Setup Node.js
        if: env.DONE != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Setup .NET
        if: env.DONE != 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.x

      - name: Install Velopack CLI
        if: env.DONE != 'true'
        run: dotnet tool install -g vpk

      - name: Install Dependencies
        if: env.DONE != 'true'
        run: npm ci

      - name: Generate and preprocess release notes
        if: env.DONE != 'true'
        run: ./scripts/ci/generate-release-notes.sh "${{ github.repository }}" "${{ github.sha }}"
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Apple certificates and notary profile
        id: install_certs
        if: env.DONE != 'true' && runner.os == 'macOS' && env.MAC_CERTS_P12 != ''
        env:
          MAC_CERTS_P12: ${{ secrets.MAC_CERTS_P12 }}
          MAC_CERTS_PASSWORD: ${{ secrets.MAC_CERTS_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # create variables for file paths
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # import certificate from secrets
          echo -n "$MAC_CERTS_P12" | base64 --decode -o $CERTIFICATE_PATH

          # create temporary keychain
          security create-keychain -p "$MAC_CERTS_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$MAC_CERTS_PASSWORD" $KEYCHAIN_PATH

          # import certificate to keychain
          security import $CERTIFICATE_PATH -P "$MAC_CERTS_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$MAC_CERTS_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # create notarytool profile using keychain
          xcrun notarytool store-credentials --apple-id "$APPLE_ID" --team-id "$APPLE_TEAM_ID" --password "$APPLE_PASSWORD" --keychain "$KEYCHAIN_PATH" velopack-profile

      - name: Install AzureSignTool
        if: env.DONE != 'true' && runner.os == 'Windows'
        run: dotnet tool install -g AzureSignTool

      - name: Download previous Velopack releases
        if: env.DONE != 'true' && needs.validate.outputs.skip_s3_upload != 'true'
        run: |
          echo "Downloading previous releases for channel: $FULL_CHANNEL"
          vpk download s3 --bucket griptape-nodes-desktop-releases --region us-west-2 --channel "$FULL_CHANNEL" --prefix "$USER_CHANNEL/"
        shell: bash

      - name: Build with Velopack
        if: env.DONE != 'true'
        run: |
          echo "Building for channel: $FULL_CHANNEL"

          if [ "$RUNNER_OS" == "Linux" ]; then
            ./scripts/build-linux.sh "$FULL_CHANNEL"
          elif [ "$RUNNER_OS" == "macOS" ]; then
            ./scripts/build-osx.sh "$FULL_CHANNEL"
          elif [ "$RUNNER_OS" == "Windows" ]; then
            powershell -ExecutionPolicy Bypass -File ./scripts/build-windows.ps1 -Channel "$FULL_CHANNEL"
          fi
        shell: bash
        env:
          MAC_CERTS_P12: ${{ secrets.MAC_CERTS_P12 }}
          APPLE_IDENTITY: ${{ secrets.APPLE_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          AZURE_KEY_VAULT_URI: ${{ secrets.AZURE_KEY_VAULT_URI }}
          AZURE_KEY_VAULT_CERTIFICATE_NAME: ${{ secrets.AZURE_KEY_VAULT_CERTIFICATE_NAME }}
          AZURE_KEY_VAULT_CLIENT_ID: ${{ secrets.AZURE_KEY_VAULT_CLIENT_ID }}
          AZURE_KEY_VAULT_CLIENT_SECRET: ${{ secrets.AZURE_KEY_VAULT_CLIENT_SECRET }}
          AZURE_KEY_VAULT_TENANT_ID: ${{ secrets.AZURE_KEY_VAULT_TENANT_ID }}

      - name: Retrieve notarization logs on failure
        if: failure() && runner.os == 'macOS' && env.DONE != 'true'
        run: |
          echo "Retrieving notarization history..."
          xcrun notarytool history --keychain-profile "velopack-profile" --keychain "$RUNNER_TEMP/app-signing.keychain-db" || true

          echo "Fetching detailed log for most recent submission..."
          SUBMISSION_ID=$(xcrun notarytool history --keychain-profile "velopack-profile" --keychain "$RUNNER_TEMP/app-signing.keychain-db" 2>/dev/null | grep -B 2 "status: Invalid" | grep "id:" | head -1 | awk '{print $2}')

          if [ -n "$SUBMISSION_ID" ]; then
            echo "Retrieving log for submission: $SUBMISSION_ID"
            xcrun notarytool log "$SUBMISSION_ID" --keychain-profile "velopack-profile" --keychain "$RUNNER_TEMP/app-signing.keychain-db" notarization_log.json || true

            if [ -f notarization_log.json ]; then
              echo "=== Notarization Log ==="
              cat notarization_log.json
              echo "======================="
            fi
          else
            echo "Could not find submission ID"
          fi
        shell: bash

      - name: Create DMG (macOS only)
        if: env.DONE != 'true' && runner.os == 'macOS'
        run: |
          echo "Creating DMG for channel: $FULL_CHANNEL"
          ./scripts/create-dmg.sh "$FULL_CHANNEL"
        shell: bash

      - name: Upload Velopack releases
        if: env.DONE != 'true' && needs.validate.outputs.skip_s3_upload != 'true'
        run: |
          VERSION=$(node -p "require('./package.json').version")

          # Safety check: prevent accidental S3 upload to stable from non-main
          if [[ "$USER_CHANNEL" == "stable" && "${{ github.ref_name }}" != "main" ]]; then
            echo "ERROR: Refusing to upload stable channel from non-main branch"
            exit 1
          fi

          # Tag and release naming
          if [[ "$USER_CHANNEL" == "stable" ]]; then
            TAG_NAME="v${VERSION}-${OS}-${ARCH}"
            RELEASE_NAME="Griptape Nodes Desktop ${VERSION} (${OS}-${ARCH})"
          else
            TAG_NAME="v${VERSION}-${FULL_CHANNEL}"
            RELEASE_NAME="Griptape Nodes Desktop ${VERSION} (${FULL_CHANNEL})"
          fi

          echo "Uploading for channel: $FULL_CHANNEL"
          echo "Tag: $TAG_NAME"
          echo "Release name: $RELEASE_NAME"

          vpk upload s3 --bucket griptape-nodes-desktop-releases --region us-west-2 --channel "$FULL_CHANNEL" --prefix "$USER_CHANNEL/"
        shell: bash

      - name: Upload DMG to S3 (macOS only)
        if: env.DONE != 'true' && runner.os == 'macOS' && needs.validate.outputs.skip_s3_upload != 'true'
        run: |
          VERSION=$(node -p "require('./package.json').version")
          DMG_FILE="Releases/GriptapeNodes-${VERSION}-${FULL_CHANNEL}.dmg"

          if [ -f "$DMG_FILE" ]; then
            echo "Uploading DMG to S3 for channel: $FULL_CHANNEL..."
            # Upload versioned DMG
            aws s3 cp "$DMG_FILE" "s3://griptape-nodes-desktop-releases/${USER_CHANNEL}/GriptapeNodes-${VERSION}-${FULL_CHANNEL}.dmg"
            # Upload latest DMG (without version number for stable URL)
            aws s3 cp "$DMG_FILE" "s3://griptape-nodes-desktop-releases/${USER_CHANNEL}/GriptapeNodes-${FULL_CHANNEL}.dmg"
          else
            echo "Warning: DMG file not found: $DMG_FILE"
          fi
        shell: bash

      - name: Upload Setup.exe to S3 (Windows only)
        if: env.DONE != 'true' && runner.os == 'Windows' && needs.validate.outputs.skip_s3_upload != 'true'
        run: |
          VERSION=$(node -p "require('./package.json').version")
          SETUP_FILE="Releases/GriptapeNodes-${VERSION}-${FULL_CHANNEL}-Setup.exe"

          if [ -f "$SETUP_FILE" ]; then
            echo "Uploading Setup.exe to S3 for channel: $FULL_CHANNEL..."
            # Upload versioned Setup.exe
            aws s3 cp "$SETUP_FILE" "s3://griptape-nodes-desktop-releases/${USER_CHANNEL}/GriptapeNodes-${VERSION}-${FULL_CHANNEL}-Setup.exe"
            # Upload latest Setup.exe (without version number for stable URL)
            aws s3 cp "$SETUP_FILE" "s3://griptape-nodes-desktop-releases/${USER_CHANNEL}/GriptapeNodes-${FULL_CHANNEL}-Setup.exe"
          else
            echo "Warning: Setup.exe file not found: $SETUP_FILE"
          fi
        shell: bash

      - name: Clean up keychain
        if: runner.os == 'macOS' && always() && steps.install_certs.outcome == 'success'
        run: security delete-keychain $RUNNER_TEMP/app-signing.keychain-db

      - name: Upload GitHub Release Assets
        if: env.DONE != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: releases-${{ env.OS }}-${{ env.ARCH }}
          path: Releases/

      # Upload cleaned release notes only from one platform (linux-x64) to avoid conflicts
      - name: Upload cleaned release notes
        if: env.DONE != 'true' && env.OS == 'linux' && env.ARCH == 'x64'
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: RELEASE_NOTES.md

  create-github-release:
    needs: [validate, release]
    runs-on: ubuntu-latest
    if: success()

    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create unified GitHub release
        run: ./scripts/ci/create-github-release.sh "${{ needs.validate.outputs.channel }}" "${{ github.sha }}"
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
